---
title: "Checkpoint"
output:
  pdf_document: default
  html_document: default
date: "2024-07-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(factoextra)
library(patchwork)
library(cluster)
library(pheatmap)
library(survival)
library(survminer)
library(ggfortify)
```


## Loading, Cleaning, and Scaling Lung Data
```{r lung data for elbows}
lung_meta40 <- read.csv("./lung_meta40.csv")

# Select columns (include proportions and K values)
# new_lung_meta40 <- lung_meta40 |>
#   select(starts_with("k"))

new_lung_meta40 <- lung_meta40 |>
  select(starts_with("k"), starts_with("p")) |>
  select(-c(pack_years, patient_id))

# Scale data and remove rows containing NA's
new_lung_meta40 <- as.data.frame(scale(new_lung_meta40))
new_lung_meta40 <- na.omit(new_lung_meta40) 
```

## Assessing Number of Clusters
```{r lung number clusters}
# width sum of squares method (elbow plot)
wss_lung = fviz_nbclust(new_lung_meta40, hcut, method = "wss")

# silhouette method
silhouette_lung = fviz_nbclust(new_lung_meta40, hcut, method = "silhouette")

# gap statistic method 
gap_stat_lung = fviz_nbclust(new_lung_meta40, hcut, method = "gap_stat")
wss_lung + silhouette_lung + gap_stat_lung

```

Based on these results, we are planning to use two clusters hierarchical clustering (using Ward distance).

## Performing PCA
```{r pca-lung}
pca_lung40 <- prcomp(new_lung_meta40)

## view cumulative proportion of variance
summary(pca_lung40)
```
We will be using five principal components, which has a cumulative proportion of 0.627. 

## Performing Hierarchical Clustering
```{r}
set.seed(42)
# # Perform Hierarchical clustering using Ward distance and first 5 principle components
# ## Produces same dendrogram, but want different objects to draw clusters on
# hier_clust2 <- hcut(pca_lung40$x[,1:5], k = 2)
# ## 3 clusters
# hier_clust3 <- hcut(pca_lung40$x[,1:5], k = 3)
# ## 4 clusters
# hier_clust4 <- hcut(pca_lung40$x[,1:5], k = 4)
# 
# # View dendrogram and clusters
# ## 2 clusters
# plot(hier_clust2)
# rect.hclust(hier_clust2, k = 2)
# ## 3 clusters
# plot(hier_clust3)
# rect.hclust(hier_clust3, k = 3)
# ## 4 clusters
# plot(hier_clust4)
# rect.hclust(hier_clust4, k = 4)
# ## silhouette scores for hierarchical clustering
# fviz_silhouette(hier_clust2) # 0.4
# fviz_silhouette(hier_clust3) # 0.31
# fviz_silhouette(hier_clust4) # 0.31

# Perform Hierarchical clustering using Ward distance and first 5 principle components
## Produces same dendrogram, but want different objects to draw clusters on
hier_clust2 <- hcut(new_lung_meta40, k = 2)
## 3 clusters
hier_clust3 <- hcut(new_lung_meta40, k = 3)
## 4 clusters
hier_clust4 <- hcut(new_lung_meta40, k = 4)

# View dendrogram and clusters
## 2 clusters
plot(hier_clust2, cex = 0.6)
rect.hclust(hier_clust2, k = 2)
## 3 clusters
plot(hier_clust3, cex = 0.6)
rect.hclust(hier_clust3, k = 3)
## 4 clusters
plot(hier_clust4, cex = 0.6)
rect.hclust(hier_clust4, k = 4)
## silhouette scores for hierarchical clustering
fviz_silhouette(hier_clust2) # 0.11
fviz_silhouette(hier_clust3) # 0.11
fviz_silhouette(hier_clust4) # 0.10
```

## Initial EDA on Clusters Produced Using Hierarchical and K-Means
```{r, warning = FALSE}
# Create data frame for EDA for hierarchical clustering
lung_meta40_hier <- lung_meta40 |>
  filter(!is.na(k_CK) & !is.na(k_CD8) & !is.na(k_CD14) & !is.na(k_Other) & !is.na(k_Other) & !is.na(k_CD19)
         & !is.na(k_CD4) & !is.na(k_CK_CD8) & !is.na(k_CK_CD14) & !is.na(k_CK_Other) & !is.na(k_CK_CD19) & 
           !is.na(k_CK_CD4) & !is.na(k_CD8_CD14) & !is.na(k_CD8_Other) & !is.na(k_CD8_CD19) & !is.na(k_CD8_CD4)
         & !is.na(k_CD14_Other) & !is.na(k_CD14_CD19) & !is.na(k_CD14_CD4) & !is.na(k_Other_CD19) & 
           !is.na(k_Other_CD4) & !is.na(k_CD19_CD4))

# Add clusters as column
lung_meta40_hier$cluster_id_2 <- hier_clust2$cluster
lung_meta40_hier$cluster_id_3 <- hier_clust3$cluster
lung_meta40_hier$cluster_id_4 <- hier_clust4$cluster

# Count number of patients in each cluster
lung_meta40_hier |>
  group_by(cluster_id_2) |>
  count() # 71 cluster 1, 65 cluster 2

lung_meta40_hier |>
  group_by(cluster_id_3) |>
  count() # 68 cluster 1, 65 cluster 2, 3 cluster 3

lung_meta40_hier |>
  group_by(cluster_id_4) |>
  count() # 68 clutser 1, 18 cluster 2, 3 cluster 3, 47 cluster 4

# create data frame containing medians for all numeric values in each cluster produced using hierarchical clustering
lung_meta40_hier_2 <- lung_meta40_hier |>
  select(-c(cluster_id_3, cluster_id_4))
data<- lung_meta40_hier_2[, sapply(lung_meta40_hier_2, is.numeric)]
cluster_meds_2 <- data |>
  group_by(cluster_id_2) |>
  summarize(across(everything(), median, na.rm = TRUE))

lung_meta40_hier_3 <- lung_meta40_hier |>
  select(-c(cluster_id_2, cluster_id_4))
data<- lung_meta40_hier_3[, sapply(lung_meta40_hier_3, is.numeric)]
cluster_meds_3 <- data |>
  group_by(as.integer(cluster_id_3)) |>
  summarize(across(everything(), median, na.rm = TRUE))

lung_meta40_hier_4 <- lung_meta40_hier |>
  select(-c(cluster_id_3, cluster_id_2))
data <- lung_meta40_hier_4[, sapply(lung_meta40_hier_4, is.numeric)]
cluster_meds_4 <- data |>
  group_by(as.integer(cluster_id_4)) |>
  summarize(across(everything(), median, na.rm = TRUE))

colnames(lung_meta40_hier) <- c("X", "image_id", "patient_id", "gender", "mhcII_status", "age_at_diagnosis",
                                "stage_at_diagnosis", "stage_numeric", "pack_years", "survival_days",
                                "survival_status", "cause_of_death", "adjuvant_therapy",
                                "time_to_recurrence_days", "recurrence_or_lung_ca_death", "total_cell",
                                "p_Tumor", "p_CytotoxicT", "p_Macrophage", "p_Other", "p_BCell", "p_THelper",
                                "k_Tumor", "k_CytotoxicT", "k_Macrophage", "k_Other", "k_BCell", "k_THelper",
                                "k_Tumor_CytotoxicT", "k_Tumor_Macrophage", "k_Tumor_Other", "k_Tumor_BCell",
                                "k_Tumor_THelper", "k_CytotoxicT_Macrophage", "k_CytotoxicT_Other", 
                                "k_CytoxicT_BCell", "k_CytotoxicT_THelper", "k_Macrophage_Other", 
                                "k_Macrophage_BCell", "k_Macrophage_THelper", "k_Other_BCell",
                                "k_Other_THelper", "k_BCell_THelper", "cluster_id_2", "cluster_id_3",
                                "cluster_id_4")
```
Our next step will be to produce a heatmaps.

## Parsing data 
```{r binary conversion}
# Making categorical data numeric for heatmaps
lung_meta40_hier2 <- lung_meta40_hier

lung_meta40_hier2$gender <- factor(lung_meta40_hier2$gender, levels = c("M", "F"), labels = c("1","2"))

lung_meta40_hier2$mhcII_status <- factor(lung_meta40_hier2$mhcII_status, levels = c("low", "high"), labels = c("1","2"))

lung_meta40_hier2$adjuvant_therapy <- factor(lung_meta40_hier2$adjuvant_therapy, levels = c("No", "Yes"), labels = c("1","2"))

lung_meta40_hier2$gender = as.integer(lung_meta40_hier2$gender) 
lung_meta40_hier2$mhcII_status = as.integer(lung_meta40_hier2$mhcII_status)
lung_meta40_hier2$adjuvant_therapy = as.integer(lung_meta40_hier2$adjuvant_therapy) 
```

## Heatmaps
```{r, results = 'hide'}
# Creating heatmaps
## 2 clusters
set.seed(42)
file_plot <- lung_meta40_hier2 |>
  select(-c(cluster_id_3, cluster_id_4)) |>
  arrange(cluster_id_2) |>
  mutate(new_cluster_id_2 = factor(cluster_id_2)) |>
  select(-cluster_id_2)
clust <- file_plot |> select(new_cluster_id_2)
rownames(clust) = rownames(file_plot)
heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  select(-X) |>
  as.matrix()
rownames(heat_df) = rownames(clust)
rownames(clust)
pheatmap(heat_df, 
         annotation_row = clust, 
         cluster_cols = TRUE, 
         cluster_rows = FALSE,
         clustering_method = "ward.D2")


## 3 clusters
file_plot <- lung_meta40_hier2 |>
  select(-c(cluster_id_2, cluster_id_4)) |>
  arrange(cluster_id_3) |>
  mutate(new_cluster_id_3 = factor(cluster_id_3)) |>
  select(-cluster_id_3)
clust <- file_plot |> select(new_cluster_id_3)
rownames(clust) = rownames(file_plot)
heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  select(-X) |>
  as.matrix()
rownames(heat_df) = rownames(clust)
rownames(clust)
pheatmap(heat_df, 
         annotation_row = clust, 
         cluster_cols = TRUE, 
         cluster_rows = FALSE,
         clustering_method = "ward.D2")


## 4 clusters (One to use in final presentation)
file_plot <- lung_meta40_hier2 |>
  select(starts_with("p"), starts_with("k"), -pack_years, cluster_id_4) |>
  arrange(cluster_id_4) |>
  mutate(cluster_id = factor(cluster_id_4)) |>
  select(-cluster_id_4)
clust <- file_plot |> select(cluster_id) |>
  rename('Cluster' = 'cluster_id')
rownames(clust) = rownames(file_plot)
heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  as.matrix()
rownames(heat_df) = rownames(clust)
rownames(clust)
colnames(heat_df) = c("Tumor Prop.", "Cytotoxic T Prop.", "Macrophage Prop.", "Other Prop.", "B Cell Prop.", "T Helper Prop.",
                                "Tumor K", "Cytotoxic T K", "Macrophage K", "Other K", "B Cell K", "T Helper K",
                                "Tumor x Cytotoxic T", "Tumor x Macrophage", "Tumor x Other", "Tumor x B Cell",
                                "Tumor x T Helper", "Cytotoxic T x Macrophage", "Cytotoxic T x Other", 
                                "Cytoxic T x B Cell", "Cytotoxic T x T Helper", "Macrophage x Other", 
                                "Macrophage x B Cell", "Macrophage x T Helper", "Other x B Cell",
                                "Other x T Helper", "B Cell x T Helper")
pheatmap(t(heat_df), 
         annotation_col = clust, 
         cluster_cols = F, 
         cluster_rows = T,
         clustering_method = "ward.D2")

```

## Boxplots for Cluster EDA

```{r}
current_data <- lung_meta40_hier

current_data <- current_data[, sapply(current_data, is.numeric)] |>
  select(-X, -stage_numeric, -survival_status, -recurrence_or_lung_ca_death) |>
  ## Change the cluster id if needed
  pivot_longer(cols = -cluster_id_4,
               names_to = "type",
               values_to = "value") |>
  filter(cluster_id_4 != 3)

current_data |>
  ggplot(aes(x = type, y = value, col = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip() #This is for all, but you can't really tell much

## Just Proportions

current_data |>
  filter(startsWith(type, "p_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

## Just K standalone (except CK, because it was harder to see)

current_data |>
  filter(type %in% c('k_CD8', 'k_CD4', 'k_CD19', 'k_CD14', 'k_Other')) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

current_data |>
  filter(type == 'k_CK') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() 

## K Crosses for CK (WE ARE USING THIS)

current_data |>
  filter(startsWith(type, "k_CK_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip() 

## K Crosses for CD8

current_data |>
  filter(startsWith(type, "k_CD8_") | endsWith(type, "_CD8"),
         type != 'p_CD8',
         type != 'k_CD8') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

# K Crosses for CD14

current_data |>
  filter(startsWith(type, "k_CD14_")  | endsWith(type, "_CD14"),
         type != 'p_CD14',
         type != 'k_CD14') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

# K Crosses for Other

current_data |>
  filter(startsWith(type, "k_Other_")  | endsWith(type, "_Other"),
         type != 'p_Other',
         type != 'k_Other') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

# Last K Cross for CD19

current_data |>
  filter(startsWith(type, "k_CD19_")  | endsWith(type, "_CD19"),
         type != 'p_CD19',
         type != 'k_CD19') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

# For metadata

current_data |>
  filter(!startsWith(type, "k_"), !startsWith(type, "p_"), 
         type != "pack_years", type != 'age_at_diagnosis',
         type != 'cluster_id_3', type != 'cluster_id_2') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

current_data |>
  filter(type == "pack_years"| type == 'age_at_diagnosis') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) +
  geom_boxplot() +
  coord_flip()

# pack years alone
current_data %>% 
  filter(type == "pack_years") %>% 
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) + 
  geom_boxplot() + 
  scale_fill_discrete(name = "cluster_id") + 
  ggtitle("Distribution of Pack Years") +
  labs(y = "Pack Years", x = " ") + theme_bw()

# age alone
current_data %>% 
  filter(type == "age_at_diagnosis") %>% 
  ggplot(aes(x = type, y = value, fill = factor(cluster_id_4))) + 
  geom_boxplot() + 
  scale_fill_discrete(name = "cluster_id") + 
  ggtitle("Distribution of Age at Diagnosis") +
  labs(y = "Age", x = " ") + theme_bw()
  
```

## Survival Analysis 

```{r}
current_data <- lung_meta40_hier |>
  filter(cluster_id_4 != 3)

km_fit <- survfit(Surv(survival_days, survival_status) ~ cluster_id_4, data = current_data)
ggsurvplot(km_fit, data = current_data)
survdiff(Surv(survival_days, survival_status) ~ cluster_id_4, data= current_data, rho = 1)
```

## Barplots

```{r}
current_data <- lung_meta40_hier |>
  filter(cluster_id_4 != 3)

current_data <- current_data |> select_if(~!is.numeric(.)) |>
  mutate(stage_numeric = current_data$stage_numeric,
         #Change based on which cluster
         cluster_id = current_data$cluster_id_4) |>
  select(-image_id, -patient_id, -cause_of_death, -stage_at_diagnosis) 

current_data |>
  select(cluster_id, gender) |>
  ggplot(aes(x = factor(cluster_id), fill = gender)) +
  geom_bar(position = 'fill') +
  scale_fill_discrete(name = "Gender") +
  ggtitle("Proportions of Gender") +
  labs(y = "Percentage", x = "cluster_id") + theme_bw()

current_data |>
  select(cluster_id, mhcII_status) |>
  ggplot(aes(x = factor(cluster_id), fill = mhcII_status)) +
  geom_bar(position = 'fill')

current_data |>
  select(cluster_id, adjuvant_therapy) |>
  ggplot(aes(x = factor(cluster_id), fill = adjuvant_therapy)) +
  geom_bar(position = 'fill')

current_data |>
  select(cluster_id, stage_numeric) |>
  ggplot(aes(x = factor(cluster_id), fill = factor(stage_numeric))) +
  geom_bar(position = 'fill') +
  scale_fill_discrete(name = "Stage of Cancer") +
  ggtitle("Proportions of Stage of Cancer") +
  labs(y = "Percentage", x = "cluster_id") + theme_bw()
  

```
## Survival with Time to Recurrence

```{r}
recurrence_data <- lung_meta40_hier |>
  select(patient_id, survival_days, time_to_recurrence_days, cluster_id_4) |>
  mutate(recurrence = if_else(is.na(time_to_recurrence_days), 0, 1),
         recurrence_days = if_else(is.na(time_to_recurrence_days), survival_days, time_to_recurrence_days)) |>
  filter(cluster_id_4 != 3) |>
  rename('Cluster' = 'cluster_id_4')

km_fit_rec <- survfit(Surv(recurrence_days, recurrence) ~ Cluster, data = recurrence_data)
ggsurv <- ggsurvplot(km_fit_rec, data = recurrence_data, xlim = c(0,4500), 
                     ylab = 'Non-Recurrence Probability',
                     xlab = 'Time (Days)')
ggsurv$plot +
  scale_x_continuous(breaks = seq(0, 4500, by = 1000)) +
  labs(title = 'Kaplan-Meier Curve for Cancer Recurrence') +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) 


survdiff(Surv(recurrence_days, recurrence) ~ Cluster, data = recurrence_data, rho = 0)
autoplot(km_fit_rec, xlim = c(0, 5000))

recurrence_data |>
  group_by(Cluster) |>
  summarize(p_recurrence = sum(recurrence == 1) / n())

```

## Boxplots we end up using

```{r}
current_data <- lung_meta40_hier

colnames(current_data) <- c("X", "image_id", "patient_id", "gender", "mhcII_status", "age_at_diagnosis",
                                "stage_at_diagnosis", "stage_numeric", "pack_years", "survival_days",
                                "survival_status", "cause_of_death", "adjuvant_therapy",
                                "time_to_recurrence_days", "recurrence_or_lung_ca_death", "total_cell",
                                "p_Tumor", "p_CytotoxicT", "p_Macrophage", "p_Other", "p_BCell", "p_THelper",
                                "k_Tumor", "k_CytotoxicT", "k_Macrophage", "k_Other", "k_BCell", "k_THelper",
                                "k_Tumor_CytotoxicT", "k_Tumor_Macrophage", "k_Tumor_Other", "k_Tumor_BCell",
                                "k_Tumor_THelper", "k_CytotoxicT_Macrophage", "k_CytotoxicT_Other", 
                                "k_CytotoxicT_BCell", "k_CytotoxicT_THelper", "k_Macrophage_Other", 
                                "k_Macrophage_BCell", "k_Macrophage_THelper", "k_Other_BCell",
                                "k_Other_THelper", "k_BCell_THelper", "cluster_id_2", "cluster_id_3",
                                "cluster_id_4")

current_data <- current_data[, sapply(current_data, is.numeric)] |>
  select(-X, -stage_numeric, -survival_status, -recurrence_or_lung_ca_death) |>
  ## Change the cluster id if needed
  pivot_longer(cols = -cluster_id_4,
               names_to = "type",
               values_to = "value") |>
  filter(cluster_id_4 != 3) |>
  rename('Cluster' = 'cluster_id_4')

current_data |>
  filter(startsWith(type, "k_Tumor_")) |>
      mutate(type = case_when(type == 'k_Tumor_THelper' ~ 'Tumor x T Helper',
                         type == 'k_Tumor_Other' ~ 'Tumor x Other',
                          type == 'k_Tumor_Macrophage' ~ 'Tumor x Macrophage',
                          type == 'k_Tumor_CytotoxicT' ~ 'Tumor x Cytotoxic T',
                          type == 'k_Tumor_BCell' ~ 'Tumor x B Cell')) |>
  ggplot(aes(x = type, y = value, fill = factor(Cluster))) +
  geom_boxplot() +
  coord_flip() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() +
  labs(title = "Difference Between Observed and Permuted K Cross for Tumor Cell interactions",
       x = 'Cell Spatial Interaction',
       y = 'Difference',
       fill = 'Cluster') +
  theme(plot.title = element_text(size = 11))
  
current_data |>
  filter(startsWith(type, "p_")) |>
  mutate(type = case_when(type == 'p_Tumor' ~ 'Tumor',
                          type == 'p_THelper' ~ 'T Helper',
                          type == 'p_Other' ~ 'Other',
                          type == 'p_Macrophage' ~ 'Macrophage',
                          type == 'p_CytotoxicT' ~ 'Cytotoxic T',
                          type == 'p_BCell' ~ 'B Cell')) |>
  ggplot(aes(x = type, y = value, fill = factor(Cluster))) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  labs(title = "Cell Proportions within Image",
       x = 'Cell Type',
       y = 'Proportion',
       fill = 'Cluster') +
  theme(plot.title = element_text(hjust = 0.5)) 

current_data |>
  filter(startsWith(type, "k_CytotoxicT_") | endsWith(type, "_CytotoxicT"),
         type != 'p_CytotoxicT',
         type != 'k_CytotoxicT') |>
    mutate(type = case_when(type == 'k_Tumor_CytotoxicT' ~ 'Cytotoxic T x Tumor',
                         type == 'k_CytotoxicT_THelper' ~ 'Cytotoxic T x T Helper',
                          type == 'k_CytotoxicT_Other' ~ 'Cytotoxic T x Other',
                          type == 'k_CytotoxicT_Macrophage' ~ 'Cytotoxic T x Macrophage',
                          type == 'k_CytotoxicT_BCell' ~ 'Cytotoxic T x B Cell')) |>
  ggplot(aes(x = type, y = value, fill = factor(Cluster))) +
  geom_boxplot() +
  coord_flip() +
  theme_bw() +
  labs(title = "Difference Between Observed and Permuted K Cross for Cytotoxic T Cell interactions",
       x = 'Cell Spatial Interaction',
       y = 'Difference',
       fill = 'Cluster') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size = 11))

```

