---
title: "Checkpoint"
output: html_document
date: "2024-07-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(factoextra)
library(patchwork)
library(cluster)
library(pheatmap)
```


## Loading, Cleaning, and Scaling Lung Data
```{r lung data for elbows}
lung_meta40 <- read.csv("./lung_meta40.csv")

# Select columns
new_lung_meta40 <- lung_meta40 |>
  select(starts_with("k"))

# Scale data and remove rows containing NA's
new_lung_meta40 <- as.data.frame(scale(new_lung_meta40))
new_lung_meta40 <- na.omit(new_lung_meta40) 
```

## Assessing Number of Clusters
```{r lung number clusters}
# width sum of squares method (elbow plot)
wss_lung = fviz_nbclust(new_lung_meta40, kmeans, method = "wss")

# silhouette method
silhouette_lung = fviz_nbclust(new_lung_meta40, kmeans, method = "silhouette")

# gap statistic method 
gap_stat_lung = fviz_nbclust(new_lung_meta40, kmeans, method = "gap_stat")
wss_lung + silhouette_lung + gap_stat_lung

```

Based on these results, we are planning to use two clusters hierarchical clustering (using Ward distance).

## Performing PCA
```{r pca-lung}
pca_lung40 <- prcomp(new_lung_meta40)

## view cumulative proportion of variance
summary(pca_lung40)
```
We will be using five principal components, which has a cumulative proportion of 0.627. 

## Performing Hierarchical Clustering
```{r}
set.seed(42)
# hierarchical clustering using Ward distance and first 5 principle components
hier_clust <- hcut(pca_lung40$x[,1:5], k = 2)
## dendrogram
plot(hier_clust)
## clusters drawn on dendrogram
rect.hclust(hier_clust, k = 2)
## silhouette scores for hierarchical clustering
fviz_silhouette(hier_clust)
```

## Performing K-means Clustering
```{r lung number}
set.seed(42)
kmeans_lung40 <- kmeans(data.frame(pca_lung40$x[, 1:5]), centers = 2)
```

## Initial EDA on Clusters Produced Using Hierarchical and K-Means
```{r, warning = FALSE}
# Create data frame for EDA for hierarchical clustering
lung_meta40_hier <- lung_meta40 |>
  filter(!is.na(p_CK) & !is.na(p_CD8) & !is.na(p_CD14) & !is.na(p_Other) & !is.na(p_CD19) & !is.na(p_CD4)
         & !is.na(k_CK) & !is.na(k_CD8) & !is.na(k_CD14) & !is.na(k_Other) & !is.na(k_Other) & !is.na(k_CD19)
         & !is.na(k_CD4) & !is.na(k_CK_CD8) & !is.na(k_CK_CD14) & !is.na(k_CK_Other) & !is.na(k_CK_CD19) & 
           !is.na(k_CK_CD4) & !is.na(k_CD8_CD14) & !is.na(k_CD8_Other) & !is.na(k_CD8_CD19) & !is.na(k_CD8_CD4)
         & !is.na(k_CD14_Other) & !is.na(k_CD14_CD19) & !is.na(k_CD14_CD4) & !is.na(k_Other_CD19) & 
           !is.na(k_Other_CD4) & !is.na(k_CD19_CD4))

lung_meta40_hier$cluster_id <- hier_clust$cluster

# Create data frame for EDA for K-means clustering
lung_meta40_k <- lung_meta40 |>
  filter(!is.na(p_CK) & !is.na(p_CD8) & !is.na(p_CD14) & !is.na(p_Other) & !is.na(p_CD19) & !is.na(p_CD4)
         & !is.na(k_CK) & !is.na(k_CD8) & !is.na(k_CD14) & !is.na(k_Other) & !is.na(k_Other) & !is.na(k_CD19)
         & !is.na(k_CD4) & !is.na(k_CK_CD8) & !is.na(k_CK_CD14) & !is.na(k_CK_Other) & !is.na(k_CK_CD19) & 
           !is.na(k_CK_CD4) & !is.na(k_CD8_CD14) & !is.na(k_CD8_Other) & !is.na(k_CD8_CD19) & !is.na(k_CD8_CD4)
         & !is.na(k_CD14_Other) & !is.na(k_CD14_CD19) & !is.na(k_CD14_CD4) & !is.na(k_Other_CD19) & 
           !is.na(k_Other_CD4) & !is.na(k_CD19_CD4))

lung_meta40_k$cluster_id <- kmeans_lung40$cluster

# count number of patients in each cluster using hierarchical
lung_meta40_hier |>
  group_by(cluster_id) |>
  count()

# count number of patients in each cluster using k-means
lung_meta40_k |>
  group_by(cluster_id) |>
  count()

# create data frame containing medians for all numeric values in each cluster produced using hierarchical clustering
data <- lung_meta40_hier[, sapply(lung_meta40_hier, is.numeric)]
cluster_meds <- data |>
  group_by(cluster_id) |>
  summarize(across(everything(), median, na.rm = TRUE))

# create data frame containing medians for all numeric values in each cluster produced using K-means clustering
data <- lung_meta40_k[, sapply(lung_meta40_k, is.numeric)]
cluster_meds <- data |>
  group_by(cluster_id) |>
  summarize(across(everything(), median, na.rm = TRUE))
```
Our next step will be to produce a heatmap using these two clusters.

## Heatmaps
```{r, results = 'hide'}
# heat map of clusters resulting from hierarchical clustering
file_plot <- lung_meta40_hier |>
  arrange(cluster_id)

clust <- file_plot |> select(cluster_id) |>
  mutate(cluster_id = factor(cluster_id))
rownames(clust) = rownames(file_plot)

heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  select(-X) |>
  as.matrix()

rownames(heat_df) = rownames(clust)
rownames(clust)

View(heat_df)

  pheatmap(heat_df, annotation_row = clust, cluster_cols = FALSE, cluster_rows = FALSE)


View(file_plot)

# heat map of clusters resulting from K-means clustering
file_plot <- lung_meta40_k |>
  arrange(cluster_id)

clust <- file_plot |> select(cluster_id) |>
  mutate(cluster_id = factor(cluster_id))
rownames(clust) = rownames(file_plot)

heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  select(-X) |>
  as.matrix()

rownames(heat_df) = rownames(clust)
rownames(clust)

View(heat_df)

  pheatmap(heat_df, annotation_row = clust, cluster_cols = FALSE, cluster_rows = FALSE)


View(file_plot)
```

