---
title: "Checkpoint"
output: html_document
date: "2024-07-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(factoextra)
library(patchwork)
library(cluster)
library(pheatmap)
library(survival)
library(survminer)
library(ggfortify)
```


## Loading, Cleaning, and Scaling Lung Data
```{r lung data for elbows}
lung_meta40 <- read.csv("./lung_meta40.csv")

# Select columns
new_lung_meta40 <- lung_meta40 |>
  select(starts_with("k"))

# Scale data and remove rows containing NA's
new_lung_meta40 <- as.data.frame(scale(new_lung_meta40))
new_lung_meta40 <- na.omit(new_lung_meta40) 
```

## Assessing Number of Clusters
```{r lung number clusters}
# width sum of squares method (elbow plot)
wss_lung = fviz_nbclust(new_lung_meta40, hcut, method = "wss")

# silhouette method
silhouette_lung = fviz_nbclust(new_lung_meta40, hcut, method = "silhouette")

# gap statistic method 
gap_stat_lung = fviz_nbclust(new_lung_meta40, hcut, method = "gap_stat")
wss_lung + silhouette_lung + gap_stat_lung

```

Based on these results, we are planning to use two clusters hierarchical clustering (using Ward distance).

## Performing PCA
```{r pca-lung}
pca_lung40 <- prcomp(new_lung_meta40)

## view cumulative proportion of variance
summary(pca_lung40)
```
We will be using five principal components, which has a cumulative proportion of 0.627. 

## Performing Hierarchical Clustering
```{r}
set.seed(42)
# Perform Hierarchical clustering using Ward distance and first 5 principle components
## Produces same dendrogram, but want different objects to draw clusters on
hier_clust2 <- hcut(pca_lung40$x[,1:5], k = 2)
## 3 clusters
hier_clust3 <- hcut(pca_lung40$x[,1:5], k = 3)
## 4 clusters
hier_clust4 <- hcut(pca_lung40$x[,1:5], k = 4)

# View dendrogram and clusters
## 2 clusters
plot(hier_clust2)
rect.hclust(hier_clust2, k = 2)
## 3 clusters
plot(hier_clust3)
rect.hclust(hier_clust3, k = 3)
## 4 clusters
plot(hier_clust4)
rect.hclust(hier_clust4, k = 4)
## silhouette scores for hierarchical clustering
fviz_silhouette(hier_clust2) # 0.4
fviz_silhouette(hier_clust3) # 0.31
fviz_silhouette(hier_clust4) # 0.31
```

## Initial EDA on Clusters Produced Using Hierarchical and K-Means
```{r, warning = FALSE}
# Create data frame for EDA for hierarchical clustering
lung_meta40_hier <- lung_meta40 |>
  filter(!is.na(k_CK) & !is.na(k_CD8) & !is.na(k_CD14) & !is.na(k_Other) & !is.na(k_Other) & !is.na(k_CD19)
         & !is.na(k_CD4) & !is.na(k_CK_CD8) & !is.na(k_CK_CD14) & !is.na(k_CK_Other) & !is.na(k_CK_CD19) & 
           !is.na(k_CK_CD4) & !is.na(k_CD8_CD14) & !is.na(k_CD8_Other) & !is.na(k_CD8_CD19) & !is.na(k_CD8_CD4)
         & !is.na(k_CD14_Other) & !is.na(k_CD14_CD19) & !is.na(k_CD14_CD4) & !is.na(k_Other_CD19) & 
           !is.na(k_Other_CD4) & !is.na(k_CD19_CD4))

# Add clusters as column
lung_meta40_hier$cluster_id_2 <- hier_clust2$cluster
lung_meta40_hier$cluster_id_3 <- hier_clust3$cluster
lung_meta40_hier$cluster_id_4 <- hier_clust4$cluster

# Count number of patients in each cluster
lung_meta40_hier |>
  group_by(cluster_id_2) |>
  count() # 22 cluster 1, 114 cluster 2

lung_meta40_hier |>
  group_by(cluster_id_3) |>
  count() # 22 cluster 1, 18 cluster 2, 96 cluster 3

lung_meta40_hier |>
  group_by(cluster_id_4) |>
  count() # 19 clutser 1, 18 cluster 2, 3 cluster 3, 96 cluster 4

# create data frame containing medians for all numeric values in each cluster produced using hierarchical clustering
lung_meta40_hier_2 <- lung_meta40_hier |>
  select(-c(cluster_id_3, cluster_id_4))
data<- lung_meta40_hier_2[, sapply(lung_meta40_hier_2, is.numeric)]
cluster_meds_2 <- data |>
  group_by(cluster_id_2) |>
  summarize(across(everything(), median, na.rm = TRUE))

lung_meta40_hier_3 <- lung_meta40_hier |>
  select(-c(cluster_id_2, cluster_id_4))
data<- lung_meta40_hier_3[, sapply(lung_meta40_hier_3, is.numeric)]
cluster_meds_3 <- data |>
  group_by(as.integer(cluster_id_3)) |>
  summarize(across(everything(), median, na.rm = TRUE))

lung_meta40_hier_4 <- lung_meta40_hier |>
  select(-c(cluster_id_3, cluster_id_2))
data <- lung_meta40_hier_4[, sapply(lung_meta40_hier_4, is.numeric)]
cluster_meds_4 <- data |>
  group_by(as.integer(cluster_id_4)) |>
  summarize(across(everything(), median, na.rm = TRUE))
```
Our next step will be to produce a heatmaps.

## Parsing data 
```{r binary conversion}
# Making categorical data numeric for heatmaps
lung_meta40_hier2 <- lung_meta40_hier

lung_meta40_hier2$gender <- factor(lung_meta40_hier2$gender, levels = c("M", "F"), labels = c("1","2"))

lung_meta40_hier2$mhcII_status <- factor(lung_meta40_hier2$mhcII_status, levels = c("low", "high"), labels = c("1","2"))

lung_meta40_hier2$adjuvant_therapy <- factor(lung_meta40_hier2$adjuvant_therapy, levels = c("No", "Yes"), labels = c("1","2"))

lung_meta40_hier2$gender = as.integer(lung_meta40_hier2$gender) 
lung_meta40_hier2$mhcII_status = as.integer(lung_meta40_hier2$mhcII_status)
lung_meta40_hier2$adjuvant_therapy = as.integer(lung_meta40_hier2$adjuvant_therapy) 
```

## Heatmaps
```{r, results = 'hide'}
# Creating 3 Heatmaps
## 2 clusters
file_plot <- lung_meta40_hier2 |>
  select(-c(cluster_id_3, cluster_id_4)) |>
  arrange(cluster_id_2)
clust <- file_plot |> select(cluster_id_2) |>
  mutate(cluster_id_2 = factor(cluster_id_2))
rownames(clust) = rownames(file_plot)
heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  select(-X) |>
  as.matrix()
rownames(heat_df) = rownames(clust)
rownames(clust)
pheatmap(heat_df, annotation_row = clust, cluster_cols = FALSE, cluster_rows = FALSE)
View(file_plot)

## 3 clusters
file_plot <- lung_meta40_hier2 |>
  select(-c(cluster_id_2, cluster_id_4)) |>
  arrange(cluster_id_3)
clust <- file_plot |> select(cluster_id_3) |>
  mutate(cluster_id_3 = factor(cluster_id_3))
rownames(clust) = rownames(file_plot)
heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  select(-X) |>
  as.matrix()
rownames(heat_df) = rownames(clust)
rownames(clust)
pheatmap(heat_df, annotation_row = clust, cluster_cols = FALSE, cluster_rows = FALSE)
View(file_plot)

## 4 clusters
file_plot <- lung_meta40_hier2 |>
  select(-c(cluster_id_3, cluster_id_2)) |>
  arrange(cluster_id_4)
clust <- file_plot |> select(cluster_id_4) |>
  mutate(cluster_id_4 = factor(cluster_id_4))
rownames(clust) = rownames(file_plot)
heat_df <- file_plot[, sapply(file_plot, is.numeric)] |>
  scale() |>
  as.data.frame() |>
  select(-X) |>
  as.matrix()
rownames(heat_df) = rownames(clust)
rownames(clust)
pheatmap(heat_df, annotation_row = clust, cluster_cols = FALSE, cluster_rows = FALSE)
View(file_plot)
```

## Boxplots for Cluster EDA

```{r}
current_data <- lung_meta40_hier

current_data <- current_data[, sapply(current_data, is.numeric)] |>
  select(-X, -stage_numeric, -survival_status, -recurrence_or_lung_ca_death) |>
  pivot_longer(cols = -last_col(),
               names_to = "type",
               values_to = "value") 

current_data |>
  ggplot(aes(x = type, y = value, col = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip() #This is for all, but you can't really tell much

## Just Proportions

current_data |>
  filter(startsWith(type, "p_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

## Just K standalone (except CK, because it was harder to see)

current_data |>
  filter(type %in% c('k_CD8', 'k_CD4', 'k_CD19', 'k_CD14', 'k_Other')) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

current_data |>
  filter(type == 'k_CK') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
   geom_boxplot() 

## K Crosses for CK

current_data |>
  filter(startsWith(type, "k_CK_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

## K Crosses for CD8

current_data |>
  filter(startsWith(type, "k_CD8_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

# K Crosses for CD14

current_data |>
  filter(startsWith(type, "k_CD14_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

# K Crosses for Other

current_data |>
  filter(startsWith(type, "k_Other_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

# Last K Cross for CD19

current_data |>
  filter(startsWith(type, "k_CD19_")) |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

# For metadata

current_data |>
  filter(!startsWith(type, "k_"), !startsWith(type, "p_"), 
         type != "pack_years", type != 'age_at_diagnosis') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()

current_data |>
  filter(type == "pack_years"| type == 'age_at_diagnosis') |>
  ggplot(aes(x = type, y = value, fill = factor(cluster_id))) +
  geom_boxplot() +
  coord_flip()
```

## Survival Analysis 

```{r}
current_data <- lung_meta40_hier

km_fit <- survfit(Surv(survival_days, survival_status) ~ cluster_id, data = current_data)
autoplot(km_fit)
survdiff(Surv(survival_days, survival_status) ~ cluster_id, data= current_data, rho = 1)
```


